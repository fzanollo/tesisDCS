In this section, we present the \DCS algorithm, which performs an 
on-the-fly 
exploration of the state space to find a solution to a compositional 
supervisory 
control problem. We discuss correctness and completeness of 
DCS.\\
In the next section, we present a heuristic that guides \DCS by 
exploiting the 
componentized way in which complex environments are described.


\input{pseudocode.tex}


\begin{notation}
We say that a state $s$ is winning (resp. losing) in a problem $\E = 
(E, A_E^C)$ 
with $s$ being the initial state of $E$ if there is a (resp. is no) 
solution for $\E$. We 
will refer to winning and losing states in $E$ when $A_E^C$ is clear 
from the context 
and also use $W_E$ and $L_E$ to denote the set of winning and 
losing states of $\E$.
\end{notation}


The algorithm (see Listing~\ref{lst:dcs}) incrementally explores the 
state space of  
$E$ relying on a partial exploration structure ($ES$), adding one 
transition to it at a 
time. 


\begin{definition}
[Partial Exploration] \label{def:unexploredTo}

Let $E = (S_E,$ $A_E, \D_E, \init{e}, M_E)$. We say $ES$ is a partial 
exploration of $E$ ($ES \subseteq E$) if $S_\structure \subseteq 
S_E$ and $\structure = (S_\structure,A_E, \D_\structure,\init{e},M_E 
\cap S_\structure)$, where $ \D_\structure \subseteq (\D_E \cap 
(S_\structure \times A_E \times S_\structure))$.
We write $ES \subset E$ when $S_\structure \subset S_E$.
\end{definition}

To better explain the algorithm and argue its correctness and 
completeness we 
introduce two new control problems for partial explorations. One 
takes an 
optimistic view of the unexplored region ($\top$) by assuming that 
all unexplored 
transitions lead to a winning state. The other takes a pessimistic 
($\bot$) 
view by assuming unexplored transitions lead to losing states. 

\begin{definition}
[$\top$ and $\bot$ Control Problems] \label{def:unexploredTo}

Let $\E = (E, A_E^C)$, $E = (S_E,A_E,\D_E,\init{e},M_E)$ and $\structure = 
(S_\structure,A_E, \D_\structure,\init{e},M_E \cap S_\structure)$, and $\structure 
\subseteq E$.
\\
We define $\E_\top$ as $(\unexploredToTop{\structure}, A_E^C)$ where 
$\unexploredToTop{\structure} = (S_\structure \cup \, \{\top\},A_E,\D_\top, 
\init{e}, 
(M_E \cap S_\structure)\, \cup \, \{\top\})$ and $\, \D_\top \, = \, \D_\structure 
\, 
\cup\, \{(s,\l, \top) 
\;$ $ | \; \exists s' \ldot (s, \l, s') \in (\D_E \setminus \D_\structure)\} \cup \{(\top, \l, \top) \, | \, \l \in A_E\}$ \\
We define $\E_\bot$ as $(\unexploredToBottom{\structure}, A_E^C)$ where 
$\unexploredToBottom{\structure} = (S_\structure \, \cup \, 
\{\bot\},A_E,\D_\bot, 
\init{e}, M_E \cap S_\structure)$ and $\D_\bot = \D_\structure \, \cup \, \{(s,\l, 
\bot) \, | \, $ $ \exists s' \ldot (s, \l, s') \in (\D_E \setminus \D_\structure)\}$ 
\end{definition}

We use these control problems to decide early if a state $s$ is winning or losing in $E$ 
based on what we have explored in $\structure$. If $s$ is winning in 
$\unexploredToBottom{\structure}$ this means that no matter where unexplored transitions 
lead to, $s$ will also be winning in $E$. Similarly, $s$ is losing in $E$ if it loses in  
$\unexploredToTop{\structure}$. Lemma~\ref{lem:WESandLesMonotonicity} supports this 
reasoning.




\begin{lemma}[$\WES$ and $\LES$ Monotonicity]
\label{lem:WESandLesMonotonicity}
Let $ES$ and $ES'$ be two partial explorations of $E$ such that $ES 
\subset ES'$ then $\WES \subseteq \WESS$ and $\LES \subseteq 
\LESS$.
\end{lemma}

\begin{Proof Sketch}
To prove $\WES \subseteq \WESS$ we show that a supervisor for a 
state $s$ in $\WES$ 
can be used as a supervisor from $s$ in $\WESS$. For $\LES \subseteq 
\LESS$, we assume 
there is a state $s \in \LES \setminus \LESS $. We reach a 
contradiction by showing that the 
supervisor that $s$ must have in 
$\unexploredToTop{\structure'}$ is also a 
supervisor for $s$ in $\unexploredToTop{\structure}$.\hfill$\qed$
\end{Proof Sketch}

The algorithm iteratively adds one transition from $E$ to $\structure$ at a time and ensures 
that by the end of each iteration, states in $ES$ are correctly and completely classified into 
winning and losing if there is sufficient information about $E$ in $ES$. Sets $Errors$, 
$Goals$ and $\NONE$ are used for this purpose. 

\begin{property}[Invariant]
\label{def:invariant}
The  main loop of Algorithm~\ref{lst:dcs} has the following 
invariant: 
$\structure \subseteq E \ \wedge $ $\forall s \in \structure \ldot (s\in\Goals 
\Leftrightarrow 
s \in 
\WES)$ $\wedge$  $(s\in\Errors 
\Leftrightarrow s \in \LES)$ $\wedge$  
$s\in\Errors\uplus\Goals\uplus\NONE$

% \begin{tabbing}
% ajfdlkadl\= \kill
% \> \= 
% \>$s\in\Goals \Leftrightarrow s \in \WES \wedge$ \\
% \> $s\in\Errors \Leftrightarrow s \in \LES \wedge$ \\
% \> $s\in\Errors\uplus\Goals\uplus\NONE$
% \end{tabbing}
\end{property}

The explanation of Algorithm~\ref{lst:dcs} that follows provides also 
a proof sketch of Property~\ref{def:invariant}.   

To begin with, note that function \texttt{expandNext} 
(line~\ref{line:expand}) returns a new transition 
$e \step{\l}{E} e'$ 
guaranteeing that $e$ is already in $\structure$ and $e \in \NONE$. 
This means that in each iteration, some new information is available 
for a state that is not yet known to be a 
winning or losing in $E$.  

If state $e'$ is already known to be a winning in 
$\unexploredToBottom{\structure}$ (line~\ref{line:isWinning}) or 
losing in $\unexploredToTop{\structure}$ (line~\ref{line:isLosing}) 
then this information needs to be propagated to states in $\NONE$ 
to see if they become winners in 
$\unexploredToBottom{\structure'}$ or losers in 
$\unexploredToTop{\structure'}$. Both \texttt{propagateGoal} and 
\texttt{propagateError} apply a standard fix point 
computation~\cite{Ramadge:1989:CDES} over 
$\unexploredToBottom{\structure}$ and 
$\unexploredToTop{\structure}$ but only over predecessors of $e'$ 
that are in $\NONE$. 
Lemma~\ref{lem:newWinnersLosersAreNonePredecessors} ensures 
completeness of this 
restricted propagation.

%Hack de titulo de lemma porque si no, no corta linea.
\begin{lemma}\textbf{\emph{(New winners/losers can reach 
new transitions via \textit{None}-states)}}
\label{lem:newWinnersLosersAreNonePredecessors}
Let the transition $e \step{\l}{\structure} e'$ be the only difference between two partial explorations, $\structure$ and $\structure'$, of $E$. If $s \notin (\WES \cup \LES)$ and $s \in (\WESS \cup \LESS)$, then there are $s_0, \ldots, s_n \notin (\WES \cup \LES)$ such that $s = s_0 \wedge
s_0 \step{\l_0}{\structure}\ldots s_{n} \step{\l}{\structure} e'$.
\end{lemma}

\begin{Proof Sketch}
%We first show there is a path from $s$ to $e'$ by assuming there is none. If $s 
%\notin 
%\WES \cup \LES$ then it has a supervisor $\sigma$ in 
%$\unexploredToTop{\structure}$ but it does not have one in 
%$\unexploredToBottom{\structure}$. This depends entirely on the descendants of 
%$s$, since those are the only states that supervisors can reach in $\structure$. 
If $s$ 
is not a predecessor of $e'$, as $e \step{l}{\structure'} e'$ is the only difference 
between $\structure$ and $\structure'$, then the descendants of $s$ are the same, 
thus its possible supervisors in $\unexploredToTop{\structure'}$ and 
$\unexploredToBottom{\structure'}$ are unchanged. Thus, $s \notin \WESS \cup 
\LESS$ which is a contradiction.

We then prove that there is at least one path from $s$ to $e'$ via $\NONE$ states by 
contradiction assuming that all paths to $e'$ in $\structure'$ cross a state $s' \in 
(\WES \cup \LES)$. A supervisor $\sigma$ from $s$ in 
$\unexploredToTop{\structure}$ will not reach states in $\LES$, 
thus for all $s'$ it crosses they will have a supervisors $\sigma_{s'}$ for 
$\unexploredToBottom{\structure}$. We use $\sigma$ and $\sigma_{s'}$  to 
build a supervisor for $s$ in $\unexploredToTop{\structure'}$ to show that $s 
\not\in \LESS$.
A supervisor for $s$ in $\unexploredToBottom{\structure'}$ cannot exist because 
otherwise we can use it to build a supervisor for $s$ in 
$\unexploredToBottom{\structure}$ using a similar reasoning as before. This means 
that $s \in 
\WES$ contradicting hypothesis. \hfill$\qed$
\end{Proof Sketch}

By line~\ref{line:isLoop} we know that $e'$ is not winning in  
$\unexploredToBottom{\structure}$ nor losing in 
$\unexploredToTop{\structure}$, we check if $e 
\step{\l}{\structure} e'$ closes a new loop. If this is not the case, there is nothing to 
do because $e'$ must have 
the same reachable transitions in $\structure'$ as in $\structure$. Thus, $e' \notin 
(\WESS \cup \LESS)$ as any supervisor for $e'$ in 
$\unexploredToBottom{\structure'}$ (resp. $\unexploredToTop{\structure'}$) is also a 
supervisor in $\unexploredToBottom{\structure}$ (resp. 
$\unexploredToTop{\structure}$)  and vice versa.  
%Thus, there is no new information about whether it is winning or 
%losing (Lemma~\ref{lem:noNewLoopImpliesNoNewInformation}). 
%
%%Hack de titulo de lemma porque si no, no corta linea.
%\begin{lemma}\textbf{\emph{(No new reachable transitions from e' implies no new 
%information)}}
%\label{lem:noNewLoopImpliesNoNewInformation}
%Let $e \step{\l}{} e'$ be the only difference between two partial explorations, 
%$\structure$ and $\structure'$ and $e' \notin \WES \cup \LES$. 
%If $\, \forall (s \step{\l'}{} s') \ldot e' \runw{w}{\structure} s  \step{\l'}{\structure} s' $ 
%if and only if $e' \runw{w}{\structure'} s  \step{\l'}{\structure'} s' $ then 
%$e' \notin \WESS \cup \LESS$
%\end{lemma}
%
Furthermore, no new information on $e'$ implies there are no new winners or 
losers (Lemma~\ref{lem:E'isNoneThenAllIsNone})

\begin{lemma}\textbf{\emph{(New winners/losers only if $e'$ 
is a new winner/loser)}}
\label{lem:E'isNoneThenAllIsNone}
Let $e \step{\l}{} e'$ be the only difference between two partial explorations, $\structure$ and $\structure'$. If $\WESS \neq \WES \Rightarrow e' \in \WESS \setminus \WES$, and if $\LESS \neq \LES \Rightarrow e' \in \LESS \setminus \LES$.
%Then for all $s$ such that 
%$\exists w \ldot s \runw{w}{\structure'} e'$, if $s \notin (\WES \cup \LES)$ then $s \notin (\WESS \cup \LESS)$.
\end{lemma}

\begin{Proof Sketch}
Assuming $e' \notin \WESS$, we use a witness $s$ to $\WESS \neq 
\WES$ to reach a contradiction. State $s$ must have a supervisor in 
$\WESS$  that avoids $e \step{\l}{} e'$ which is the only difference 
between $\unexploredToBottom{\structure}$ and 
$\unexploredToBottom{\structure'}$. This supervisor is then also a 
supervisor for $s$ in $\WES$ reaching a contradiction. 

If we assume $e' \notin \LESS$.  We use a witness $s$ to $\LESS 
\neq 
\LES$ to reach a contradiction. Note that as $e' \notin \LESS$, there 
is a supervisor $\sigma$ from $e'$ in  
$\unexploredToTop{\structure'}$.  As $s \notin \LES$ it also must 
have a 
supervisor $\sigma'$ in  $\unexploredToTop{\structure}$. We build 
a 
new supervisor for $\unexploredToTop{\structure'}$ from $s$ that 
works just like $\sigma'$ but when it reaches $e \step{\l}{} e'$ it 
behaves as $\sigma$. This new supervisor proves that $s \in \LESS$ 
which is a contradiction. \hfill$\qed$
\end{Proof Sketch}

If a new loop has been closed (line~\ref{line:isLoop}), because of 
Lemma~\ref{lem:E'isNoneThenAllIsNone} it suffices to analyse if $e' 
\in \WESS \uplus \LESS$, and by 
Lemma~\ref{lem:newWinnersLosersAreNonePredecessors} to 
propagate any new information on $e'$ to its predecessors. 

In line~\ref{line:getMaxLoop} we compute $\SCC$, the set of states that belong to a 
loop that uses $e \step{\l}{\structure'} e'$ and never enters $\WES \cup \LES$. 
Intuitively, any supervisor for $e'$ will rely on one of these loops. Or, in terms of 
Lemma~\ref{lem:newWinnersLosersAreNonePredecessors}, for $e'$ to change its 
status, it must be through a path of \textit{none}-states. 

In line~\ref{line:CanBeWinning} we use \texttt{canBeWinningLoop}($\SCC$) to 
check 
if there is a marked state in $\SCC$ or it is possible to exit $\SCC$ and reach a goal 
in one step. This determines if 
either $e' \in \WESS$ or $e' \in \LESS$ is possible (see 
Lemma~\ref{lem:canBeWinningLoopWorks}). 

\begin{lemma}\textbf{\emph{(Necessary/sufficient condition to win/lose)}}
\label{lem:canBeWinningLoopWorks}
Let $e \step{\l}{} e'$ be the only difference between two partial explorations, 
$\structure$ and $\structure'$. Let $\SCC$ = \emph{\texttt{getMaxLoop($e$, 
$e'$)}}.
If $e' \in \WESS \setminus \WES$ 
then \emph{\texttt{canBeWinningLoop}($\SCC$)}. In addition, if \\ 
\emph{\texttt{canBeWinningLoop}($\SCC$)} then $e' \notin \LESS$ 
\end{lemma}

\begin{Proof Sketch}
To prove $e' \in \WESS \setminus \WES$ implies  \texttt{canBeWinningLoop($\SCC$)}, we  
assume \\ $\neg$\texttt{canBeWinningLoop($\SCC$)} and show that $e' \notin \WESS 
\setminus \WES$. For this, it suffices to see that if 
$\neg$\texttt{canBeWinningLoop($\SCC$)} then to reach a marked state from $e'$ it must 
exit $\SCC$ to a state $s \notin \SCC \cup \WES$ which implies  $s \notin \WESS$ 
since $s$ has no none path to $e 
\step{\l}{} e'$  (Lemma~\ref{lem:newWinnersLosersAreNonePredecessors}).
As $s$ has no supervisor in $\unexploredToBottom{\structure'}$, it is impossible 
for 
$e'$ to have one. 


To prove that \texttt{canBeWinningLoop($\SCC$)} implies $e' \notin \LESS$ we build a supervisor $\sigma'$ for $e'$ in $\unexploredToTop{\structure'}$ as 
follows: 
For a trace that stays within $\SCC$, we only choose controllable successors 
that are not 
in $\LES$. Note that there cannot be uncontrollable successors in $\LES$ because 
$\SCC \cap \LES= \emptyset$.   As soon as a trace exits $\SCC$ at a state $s'$ we 
use the supervisor for $s'$ in $\unexploredToTop{\structure'}$. 
As $s'$ cannot reach $e \step{\l}{\structure'} 
e'$ using $\NONE$ states, by 
Lemma~\ref{lem:newWinnersLosersAreNonePredecessors}, $s'$ must have such a 
supervisor. \hfill$\qed$

\end{Proof Sketch}

If \texttt{canBeWinningLoop()} returns true, at line~\ref{line:lookingForWinner}, 
we know that if $e'$ changes status it is because $e' \in \WESS$.  To check this, a standard 
fixpoint computation can be 
performed. 
%However, we introduce an optimization, namely that there must be new 
%$\NONE$-loop (i.e., a loop over states that are  $\NONE$)
%that includes the new transition that either reaches a marked state 
%or 
%can reach a winning state in one step. 
However, method 
\texttt{findNewGoalsIn} applies an optimisation based on  
Lemma~\ref{lem:newWinnersLosersAreNonePredecessors}, only 
considering states that are in a $\NONE$-loop via the new 
transition ($\SCC$).


If \texttt{canBeWinningLoop()} returns false, then we must check if  $e' \in \LESS$.
%  By Lemma~\ref{lem:newWinnersLosersAreNonePredecessors}
  %, we only consider states that are in a $\NONE$-loop 
%via the $e \step{\l}{} e'$ (i.e, the set $\SCC$). 
This can be done more efficiently than a fix-point 
computation using 
Lemma~\ref{lem:findErrorsWorks} that shows that it suffices 
to check if 
it is not possible to exit $\SCC$ and reach in one step a state not in 
$\LES$. 



%Hack de titulo de lemma porque si no, no corta linea.
\begin{lemma}\textbf{\emph{(findNewErrorsIn is correct and complete)}}
\label{lem:findErrorsWorks}
If $\SCC =$ \emph{\texttt{getMaxLoop($e$, $e'$)}} $\wedge$\\ 
$\neg$\emph{\texttt{canBeWinningLoop}}($\SCC$) and \\
$P=\emph{\texttt{findNewErrorsIn}}(\SCC)$ then \\
$(e' \in \LESS \Rightarrow e' \in P 
\subseteq \LESS)$ $\wedge \, (e' \notin \LESS \Rightarrow P = 
\emptyset)$
\end{lemma}

\begin{Proof Sketch}
We split the proof based on the if/then/else structure of \texttt{findNewErrorsIn}. 
In the case of \texttt{if} being true, it suffices to prove that $e' \notin \LESS$. For this, 
we build a supervisor $\sigma'$ for $e'$ in $\unexploredToTop{\structure'}$ as 
follows: For a trace that stays within $\SCC$, we only choose controllable successors 
that are not 
in $\LES$. Note that there cannot be uncontrollable successors in $\LES$ because 
$\SCC \cap \LES= \emptyset$.   As soon as a trace exits $\SCC$ at a state $s'$ we 
use the supervisor for $s'$ in $\unexploredToTop{\structure'}$. 
As $s'$ cannot reach $e \step{\l}{\structure'} 
e'$ using $\NONE$ states, by 
Lemma~\ref{lem:newWinnersLosersAreNonePredecessors}, $s'$ must have such a 
supervisor. 

When the \texttt{if} is false, it suffices to prove $P = \SCC \subseteq \LESS$. We 
reach a contradiction  
 by assuming $s \in \SCC \setminus \LESS$: If $s 
\notin \LESS$ it has a supervisor $\sigma$ which admits a trace $w$ to a marked 
state. 
As 
there are no marked states in $\SCC$, $w$ reaches an  $s' \notin \SCC$. As 
the 
\texttt{if} was false, $s' \in \LESS$ meaning $\sigma$ is not a supervisor.
\hfill$\qed$
\end{Proof Sketch}

For efficiency,  \texttt{findNewGoalsIn} and 
\texttt{findNewErrorsIn} not only check if $e' \in \WESS$/$e' \in 
\LESS$ but also add  winning/losing states when 
possible. Complete detection of new winning and losing states is 
then done by the propagation procedures. 

Having argued that Property~~\ref{def:invariant} holds, correctness 
and completeness follow straightforwardly. 

First, note that the algorithm terminates when it has determined 
that $\init{e}$ is in $\LESS$ or $\WESS$. In the later case, it is 
straightforward to build a supervisor from the exploration structure 
$\structure$.\hfill$\qed$

\begin{theorem}[Correctness and Completeness]
Let $\E = (E,A_E^C)$ be a compositional supervisory control problem as per Definition~\ref{def:control-problem}. There exists a solution for $\E$ if and only if the DCS algorithm returns a supervisor for $\E$.
\end{theorem}

\begin{proof}
The theorem follows from the loop invariant of the algorithm 
(Definition~\ref{def:invariant}),  
Lemma~\ref{lem:WESandLesMonotonicity}, and 
the fact that in the worst case all transitions are added to the 
exploration structure. Thus,  $E = \structure = 
\unexploredToBottom{\structure} = \unexploredToTop{\structure}$.
\end{proof}