En esta sección presentamos el algoritmo \DCS, que realiza una exploración sobre la marcha de el espacio de posibilidades de los estados. Por medio de dicha exploración el algoritmo encuentra una solución al problema composicional de "supervisory control". También discutimos la correctitud y completitud del algoritmo \DCS. \\
En la próxima sección presentamos la heurística que guía \DCS aprovechando la forma composicional en el cual describimos los problemas complejos.


\input{pseudocode.tex}


\begin{notation}
Decimos que un estado $s$ es ganador["winning"] (resp. perdedor["losing"]) en el problema $\E = 
(E, A_E^C)$ siendo $s$ el estado inicial de $E$ si hay una (resp. no hay una) solución para $\E$. Nos referimos a los estados ganadores y perdedores de $E$ cuando $A_E^C$ es inferible del contexto, también usamos $W_E$ y $L_E$ para denotar el conjunto de estados ganadores y perdedores de $\E$.
\end{notation}

El algoritmo (ver Listing~\ref{lst:dcs}) explora incrementalmente el espacio de estados de $E$ utilizando una estructura de exploración parcial ($ES$), añadiéndole una transición por vez.


\begin{definition}
[Exploración Parcial] \label{def:unexploredTo}
Sea $E = (S_E,$ $A_E, \D_E, \init{e}, M_E)$. Decimos que $ES$ es una exploración parcial de $E$ ($ES \subseteq E$) si $S_\structure \subseteq 
S_E$ y $\structure = (S_\structure,A_E, \D_\structure,\init{e},M_E 
\cap S_\structure)$, donde $ \D_\structure \subseteq (\D_E \cap 
(S_\structure \times A_E \times S_\structure))$. Escribimos $ES \subset E$ cuando $S_\structure \subset S_E$.
\end{definition}

Para explicar el algoritmo y argumentar su correctitud y completitud introducimos dos nuevos problemas de control para exploraciones parciales. Uno toma una visión optimista de la región no explorada ($\top$) asumiendo que todas las transiciones no exploradas llevan a un estado ganador. El otro toma una visión pesimista ($\bot$) asumiendo que las transiciones no exploradas llevan a estados perdedores.

\begin{definition}
[Problemas de Control $\top$ y $\bot$] \label{def:unexploredTo}

Sean $\E = (E, A_E^C)$, $E = (S_E,A_E,\D_E,\init{e},M_E)$ y $\structure = 
(S_\structure,A_E, \D_\structure,\init{e},M_E \cap S_\structure)$, y $\structure 
\subseteq E$.
\\
Definimos $\E_\top$ como $(\unexploredToTop{\structure}, A_E^C)$ donde 
$\unexploredToTop{\structure} = (S_\structure \cup \, \{\top\},A_E,\D_\top, 
\init{e}, 
(M_E \cap S_\structure)\, \cup \, \{\top\})$ y $\, \D_\top \, = \, \D_\structure 
\, 
\cup\, \{(s,\l, \top) 
\;$ $ | \; \exists s' \ldot (s, \l, s') \in (\D_E \setminus \D_\structure)\} \cup \{(\top, \l, \top) \, | \, \l \in A_E\}$ \\
Definimos $\E_\bot$ como $(\unexploredToBottom{\structure}, A_E^C)$ donde 
$\unexploredToBottom{\structure} = (S_\structure \, \cup \, 
\{\bot\},A_E,\D_\bot, 
\init{e}, M_E \cap S_\structure)$ y $\D_\bot = \D_\structure \, \cup \, \{(s,\l, 
\bot) \, | \, $ $ \exists s' \ldot (s, \l, s') \in (\D_E \setminus \D_\structure)\}$ 
\end{definition}

Usamos estos problemas de control para decidir tempranamente si un estado $s$ es ganador o perdedor en $E$ basado en lo que exploramos previamente en $\structure$. Si $s$ es ganador en $\unexploredToBottom{\structure}$ esto significa que sin importar a donde lleven las transiciones no exploradas, $s$ también va a ser ganador en $E$. Similarmente, $s$ es perdedor en $E$ si es perdedor en $\unexploredToTop{\structure}$.
Lemma~\ref{lem:WESandLesMonotonicity} refuerza este razonamiento.


\begin{lemma}[Monotonicidad de $\WES$ y $\LES$]
\label{lem:WESandLesMonotonicity}
Sean $ES$ y $ES'$ dos exploraciones parciales de $E$ tal que $ES 
\subset ES'$ entonces $\WES \subseteq \WESS$ y $\LES \subseteq 
\LESS$.
\end{lemma}

\begin{Proof Sketch}
Para probar $\WES \subseteq \WESS$ mostramos que un supervisor para un estado $s$ en $\WES$ 
puede ser usado como un supervisor para $s$ en $\WESS$. Para $\LES \subseteq 
\LESS$, asumimos que hay un estado $s \in \LES \setminus \LESS $. Llegamos a una contradicción mostrando que el supervisor que $s$ debe tener en
$\unexploredToTop{\structure'}$ es también un supervisor para $s$ en $\unexploredToTop{\structure}$.\hfill$\qed$
\end{Proof Sketch}

El algoritmo agrega iterativamente una transición de $E$ a $\structure$ a la vez y asegura que al final de cada iteración, los estados en $ES$ están correcta y completamente clasificados en ganadores y perdedores si hay suficiente información de $E$ en $ES$. Los estados $Errors$, 
$Goals$ y $\NONE$ se usan para este propósito.

\begin{property}[Invariante]
\label{def:invariant}
El loop principal del Algorithm~\ref{lst:dcs} tiene el siguiente invariante: 
$\structure \subseteq E \ \wedge $ $\forall s \in \structure \ldot (s\in\Goals 
\Leftrightarrow 
s \in 
\WES)$ $\wedge$  $(s\in\Errors 
\Leftrightarrow s \in \LES)$ $\wedge$  
$s\in\Errors\uplus\Goals\uplus\NONE$

% \begin{tabbing}
% ajfdlkadl\= \kill
% \> \= 
% \>$s\in\Goals \Leftrightarrow s \in \WES \wedge$ \\
% \> $s\in\Errors \Leftrightarrow s \in \LES \wedge$ \\
% \> $s\in\Errors\uplus\Goals\uplus\NONE$
% \end{tabbing}
\end{property}

La explicación del Algorithm~\ref{lst:dcs} que detallamos a continuación sirve también como un esquema de demostración para Property~\ref{def:invariant}.   

Para empezar, notar que la función \texttt{expandNext} 
(line~\ref{line:expand}) retorna una nueva transición $e \step{\l}{E} e'$ 
garantizando que $e$ ya se encontraba en $\structure$ y $e \in \NONE$. 
Esto significa que en cada iteración, hay algo de información nueva disponible para un estado que actualmente no estaba clasificado en ganador ni perdedor en $E$.

Si el estado $e'$ ya es clasificado como ganador en
$\unexploredToBottom{\structure}$ (line~\ref{line:isWinning}) o
perdedor en $\unexploredToTop{\structure}$ (line~\ref{line:isLosing}) 
entonces esta información necesita ser propagada a los estados en $\NONE$ para ver si pueden convertirse en ganadores en 
$\unexploredToBottom{\structure'}$ o perdedores en
$\unexploredToTop{\structure'}$. Tanto \texttt{propagateGoal} como
\texttt{propagateError} realizan un punto fijo estándar~\cite{Ramadge:1989:CDES} sobre
$\unexploredToBottom{\structure}$ y
$\unexploredToTop{\structure}$ pero solo sobre predecesores de $e'$ que están en $\NONE$. 
Lemma~\ref{lem:newWinnersLosersAreNonePredecessors} asegura la completitud de esta propagación restringida.

%Hack de titulo de lemma porque si no, no corta linea.
\begin{lemma}\textbf{\emph{(Ganadores/Perdedores nuevos pueden alcanzar transiciones nuevas a traves de estados-\textit{None})}}
\label{lem:newWinnersLosersAreNonePredecessors}
Sea la transición $e \step{\l}{\structure} e'$ la única diferencia entre dos exploraciones parciales, $\structure$ y $\structure'$, de $E$. Si $s \notin (\WES \cup \LES)$ y $s \in (\WESS \cup \LESS)$, entonces hay $s_0, \ldots, s_n \notin (\WES \cup \LES)$ tal que $s = s_0 \wedge
s_0 \step{\l_0}{\structure}\ldots s_{n} \step{\l}{\structure} e'$.
\end{lemma}

\begin{Proof Sketch}
%We first show there is a path from $s$ to $e'$ by assuming there is none. If $s 
%\notin 
%\WES \cup \LES$ then it has a supervisor $\sigma$ in 
%$\unexploredToTop{\structure}$ but it does not have one in 
%$\unexploredToBottom{\structure}$. This depends entirely on the descendants of 
%$s$, since those are the only states that supervisors can reach in $\structure$. 
Si $s$ 
no es un predecesor de $e'$, como $e \step{l}{\structure'} e'$ es la única diferencia entre $\structure$ y $\structure'$, entonces los decendientes de $s$ son los mismos, 
por lo tanto sus posibles supervisores en $\unexploredToTop{\structure'}$ y
$\unexploredToBottom{\structure'}$ no cambiaron. Entonces, $s \notin \WESS \cup 
\LESS$ lo cual es una contradicción.

Paso siguiente probamos que hay al menos un camino desde $s$ a $e'$ a través de estados $\NONE$ por contradicción asumiendo que todos los caminos a $e'$ en $\structure'$ atraviesan un estado $s' \in 
(\WES \cup \LES)$. Un supervisor $\sigma$ de $s$ en 
$\unexploredToTop{\structure}$ no va a alcanzar estados en $\LES$, 
por lo tanto todo $s'$ que alcance va a tener un supervisor $\sigma_{s'}$ para 
$\unexploredToBottom{\structure}$. Usamos $\sigma$ y $\sigma_{s'}$ para construir un supervisor para $s$ en $\unexploredToTop{\structure'}$ para mostrar que $s 
\not\in \LESS$.
Un supervisor para $s$ en $\unexploredToBottom{\structure'}$ no puede existir porque de otra forma podríamos usarlo para construir un supervisor para $s$ en 
$\unexploredToBottom{\structure}$ usando un razonamiento similar al anterior. Esto significa que $s \in 
\WES$ contradiciendo la hipótesis. \hfill$\qed$
\end{Proof Sketch}

Ya en la linea~\ref{line:isLoop} sabemos que $e'$ no es ganador en $\unexploredToBottom{\structure}$ ni perdedor en $\unexploredToTop{\structure}$, chequeamos si $e 
\step{\l}{\structure} e'$ cierra un nuevo loop. SI no es el caso, entonces no hay nada que hacer ya que $e'$ debe poder alcanzar las mismas transiciones en $\structure'$ que en $\structure$. Entonces, $e' \notin 
(\WESS \cup \LESS)$ ya que cualquier supervisor para $e'$ en $\unexploredToBottom{\structure'}$ (resp. $\unexploredToTop{\structure'}$) es también un supervisor en $\unexploredToBottom{\structure}$ (resp. 
$\unexploredToTop{\structure}$) y vice versa.  
%Thus, there is no new information about whether it is winning or 
%losing (Lemma~\ref{lem:noNewLoopImpliesNoNewInformation}). 
%
%%Hack de titulo de lemma porque si no, no corta linea.
%\begin{lemma}\textbf{\emph{(No new reachable transitions from e' implies no new 
%information)}}
%\label{lem:noNewLoopImpliesNoNewInformation}
%Let $e \step{\l}{} e'$ be the only difference between two partial explorations, 
%$\structure$ and $\structure'$ and $e' \notin \WES \cup \LES$. 
%If $\, \forall (s \step{\l'}{} s') \ldot e' \runw{w}{\structure} s  \step{\l'}{\structure} s' $ 
%if and only if $e' \runw{w}{\structure'} s  \step{\l'}{\structure'} s' $ then 
%$e' \notin \WESS \cup \LESS$
%\end{lemma}
%
Más aún, que no haya nueva información para $e'$ implica que no hay nuevos ganadores o perdedores (Lemma~\ref{lem:E'isNoneThenAllIsNone})

\begin{lemma}\textbf{\emph{(Nuevos ganadores/perdedores solo si $e'$ es un nuevo ganador/perdedor)}}
\label{lem:E'isNoneThenAllIsNone}
Sea $e \step{\l}{} e'$ la única diferencia entre dos exploraciones parciales, $\structure$ y $\structure'$. Si $\WESS \neq \WES \Rightarrow e' \in \WESS \setminus \WES$, y si $\LESS \neq \LES \Rightarrow e' \in \LESS \setminus \LES$.
%Then for all $s$ such that 
%$\exists w \ldot s \runw{w}{\structure'} e'$, if $s \notin (\WES \cup \LES)$ then $s \notin (\WESS \cup \LESS)$.
\end{lemma}

\begin{Proof Sketch}
Asumiendo $e' \notin \WESS$, usamos un testigo $s$ de $\WESS \neq 
\WES$ para llegar a una contradicción. El estado $s$ debe tener un supervisor en 
$\WESS$ que evita $e \step{\l}{} e'$, la única diferencia entre $\unexploredToBottom{\structure}$ y $\unexploredToBottom{\structure'}$. Este supervisor entonces es también un supervisor para $s$ en $\WES$ llegando a una contradicción. 

Si asumimos $e' \notin \LESS$.  usamos un testigo $s$ de $\LESS \neq \LES$ para llegar a una contradicción. Notar que como $e' \notin \LESS$, hay un supervisor $\sigma$ desde $e'$ en  
$\unexploredToTop{\structure'}$. Como $s \notin \LES$ también debe haber un supervisor $\sigma'$ en $\unexploredToTop{\structure}$. Construimos un nuevo supervisor para $\unexploredToTop{\structure'}$ desde $s$ que funciona exactamente como $\sigma'$ pero cuando alcanza $e \step{\l}{} e'$ se comporta como $\sigma$. Este nuevo supervisor prueba que $s \in \LESS$ lo cual es una contradicción. \hfill$\qed$
\end{Proof Sketch}

Si se cerró un nuevo loop(line~\ref{line:isLoop}), por Lemma~\ref{lem:E'isNoneThenAllIsNone} alcanza con analizar si $e' 
\in \WESS \uplus \LESS$, y por Lemma~\ref{lem:newWinnersLosersAreNonePredecessors} propagar cualquier información nueva de $e'$ a sus predecesores. 

En la linea~\ref{line:getMaxLoop} computamos $\SCC$, el conjunto de estados que pertenecen a un loop que pasa por $e \step{\l}{\structure'} e'$ y nunca entre en $\WES \cup \LES$. 
Intuitivamente, cualquier supervisor para $e'$ va a depender de alguno de estos loops. O, en términos del Lemma~\ref{lem:newWinnersLosersAreNonePredecessors}, para que $e'$ cambie su estado, debe ser a través de un camino de estados \textit{none}. 

En la linea~\ref{line:CanBeWinning} usamos \texttt{canBeWinningLoop}($\SCC$) para chequear si existe algún estado marcado en $\SCC$ o si es posible escapar de $\SCC$ y alcanzar un "goal" en un paso. Esto distingue entre dos posibles opciones: $e' \in \WESS$ o $e' \in \LESS$ (ver 
Lemma~\ref{lem:canBeWinningLoopWorks}). 

\begin{lemma}\textbf{\emph{(Condición necesaria/suficiente para ganar/perder)}}
\label{lem:canBeWinningLoopWorks}
Let $e \step{\l}{} e'$ be the only difference between two partial explorations, 
$\structure$ and $\structure'$. Let $\SCC$ = \emph{\texttt{getMaxLoop($e$, 
$e'$)}}.
If $e' \in \WESS \setminus \WES$ 
then \emph{\texttt{canBeWinningLoop}($\SCC$)}. In addition, if \\ 
\emph{\texttt{canBeWinningLoop}($\SCC$)} then $e' \notin \LESS$ 
\end{lemma}

\begin{Proof Sketch}
To prove $e' \in \WESS \setminus \WES$ implies  \texttt{canBeWinningLoop($\SCC$)}, we  
assume \\ $\neg$\texttt{canBeWinningLoop($\SCC$)} and show that $e' \notin \WESS 
\setminus \WES$. For this, it suffices to see that if 
$\neg$\texttt{canBeWinningLoop($\SCC$)} then to reach a marked state from $e'$ it must 
exit $\SCC$ to a state $s \notin \SCC \cup \WES$ which implies  $s \notin \WESS$ 
since $s$ has no none path to $e 
\step{\l}{} e'$  (Lemma~\ref{lem:newWinnersLosersAreNonePredecessors}).
As $s$ has no supervisor in $\unexploredToBottom{\structure'}$, it is impossible 
for 
$e'$ to have one. 


To prove that \texttt{canBeWinningLoop($\SCC$)} implies $e' \notin \LESS$ we build a supervisor $\sigma'$ for $e'$ in $\unexploredToTop{\structure'}$ as 
follows: 
For a trace that stays within $\SCC$, we only choose controllable successors 
that are not 
in $\LES$. Note that there cannot be uncontrollable successors in $\LES$ because 
$\SCC \cap \LES= \emptyset$.   As soon as a trace exits $\SCC$ at a state $s'$ we 
use the supervisor for $s'$ in $\unexploredToTop{\structure'}$. 
As $s'$ cannot reach $e \step{\l}{\structure'} 
e'$ using $\NONE$ states, by 
Lemma~\ref{lem:newWinnersLosersAreNonePredecessors}, $s'$ must have such a 
supervisor. \hfill$\qed$

\end{Proof Sketch}

If \texttt{canBeWinningLoop()} returns true, at line~\ref{line:lookingForWinner}, 
we know that if $e'$ changes status it is because $e' \in \WESS$.  To check this, a standard 
fixpoint computation can be 
performed. 
%However, we introduce an optimization, namely that there must be new 
%$\NONE$-loop (i.e., a loop over states that are  $\NONE$)
%that includes the new transition that either reaches a marked state 
%or 
%can reach a winning state in one step. 
However, method 
\texttt{findNewGoalsIn} applies an optimisation based on  
Lemma~\ref{lem:newWinnersLosersAreNonePredecessors}, only 
considering states that are in a $\NONE$-loop via the new 
transition ($\SCC$).


If \texttt{canBeWinningLoop()} returns false, then we must check if  $e' \in \LESS$.
%  By Lemma~\ref{lem:newWinnersLosersAreNonePredecessors}
  %, we only consider states that are in a $\NONE$-loop 
%via the $e \step{\l}{} e'$ (i.e, the set $\SCC$). 
This can be done more efficiently than a fix-point 
computation using 
Lemma~\ref{lem:findErrorsWorks} that shows that it suffices 
to check if 
it is not possible to exit $\SCC$ and reach in one step a state not in 
$\LES$. 



%Hack de titulo de lemma porque si no, no corta linea.
\begin{lemma}\textbf{\emph{(findNewErrorsIn is correct and complete)}}
\label{lem:findErrorsWorks}
If $\SCC =$ \emph{\texttt{getMaxLoop($e$, $e'$)}} $\wedge$\\ 
$\neg$\emph{\texttt{canBeWinningLoop}}($\SCC$) and \\
$P=\emph{\texttt{findNewErrorsIn}}(\SCC)$ then \\
$(e' \in \LESS \Rightarrow e' \in P 
\subseteq \LESS)$ $\wedge \, (e' \notin \LESS \Rightarrow P = 
\emptyset)$
\end{lemma}

\begin{Proof Sketch}
We split the proof based on the if/then/else structure of \texttt{findNewErrorsIn}. 
In the case of \texttt{if} being true, it suffices to prove that $e' \notin \LESS$. For this, 
we build a supervisor $\sigma'$ for $e'$ in $\unexploredToTop{\structure'}$ as 
follows: For a trace that stays within $\SCC$, we only choose controllable successors 
that are not 
in $\LES$. Note that there cannot be uncontrollable successors in $\LES$ because 
$\SCC \cap \LES= \emptyset$.   As soon as a trace exits $\SCC$ at a state $s'$ we 
use the supervisor for $s'$ in $\unexploredToTop{\structure'}$. 
As $s'$ cannot reach $e \step{\l}{\structure'} 
e'$ using $\NONE$ states, by 
Lemma~\ref{lem:newWinnersLosersAreNonePredecessors}, $s'$ must have such a 
supervisor. 

When the \texttt{if} is false, it suffices to prove $P = \SCC \subseteq \LESS$. We 
reach a contradiction  
 by assuming $s \in \SCC \setminus \LESS$: If $s 
\notin \LESS$ it has a supervisor $\sigma$ which admits a trace $w$ to a marked 
state. 
As 
there are no marked states in $\SCC$, $w$ reaches an  $s' \notin \SCC$. As 
the 
\texttt{if} was false, $s' \in \LESS$ meaning $\sigma$ is not a supervisor.
\hfill$\qed$
\end{Proof Sketch}

For efficiency,  \texttt{findNewGoalsIn} and 
\texttt{findNewErrorsIn} not only check if $e' \in \WESS$/$e' \in 
\LESS$ but also add  winning/losing states when 
possible. Complete detection of new winning and losing states is 
then done by the propagation procedures. 

Having argued that Property~~\ref{def:invariant} holds, correctness 
and completeness follow straightforwardly. 

First, note that the algorithm terminates when it has determined 
that $\init{e}$ is in $\LESS$ or $\WESS$. In the later case, it is 
straightforward to build a supervisor from the exploration structure 
$\structure$.\hfill$\qed$

\begin{theorem}[Correctness and Completeness]
Let $\E = (E,A_E^C)$ be a compositional supervisory control problem as per Definition~\ref{def:control-problem}. There exists a solution for $\E$ if and only if the DCS algorithm returns a supervisor for $\E$.
\end{theorem}

\begin{proof}
The theorem follows from the loop invariant of the algorithm 
(Definition~\ref{def:invariant}),  
Lemma~\ref{lem:WESandLesMonotonicity}, and 
the fact that in the worst case all transitions are added to the 
exploration structure. Thus,  $E = \structure = 
\unexploredToBottom{\structure} = \unexploredToTop{\structure}$.
\end{proof}